<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Kerajaan Sang Buaya</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* [KEEPING YOUR EXISTING STYLES] */
        .audio-links {
            margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.4);
            border-radius: 12px; border-left: 5px solid #CF7A00; width: 100%; max-width: 400px; box-sizing: border-box;
        }
        .audio-links h2 { margin-top: 0; font-size: 1.1rem; margin-bottom: 10px; color: #CF7A00; }
        .audio-links-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .audio-link-item {
            display: inline-block; padding: 8px 12px; background: white; color: #333; text-decoration: none;
            border-radius: 8px; font-weight: bold; font-size: 0.85rem; border: 1px solid #ddd;
            cursor: pointer; transition: background 0.2s;
        }
        .audio-link-item:hover, .audio-link-item.active-lang { background: #FFD700; color: #000; border-color: #CF7A00; }
        
        .ar-audio-controls {
            position: absolute; top: 80px; right: 10px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px; background: rgba(0, 0, 0, 0.5);
            padding: 10px; border-radius: 10px; backdrop-filter: blur(5px);
        }
        .ar-label { color: white; font-size: 12px; text-align: center; margin-bottom: 5px; font-weight: bold; }
        .ar-btn {
            background: rgba(255, 255, 255, 0.9); border: none; padding: 8px 12px; border-radius: 20px;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .ar-btn.active-lang { background: #FFD700; color: #000; border: 2px solid white; }
        #ar-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; pointer-events: none; }
        #ar-ui > * { pointer-events: auto; }
        /* Fix for hidden UI */
        body.ar-active { background: transparent !important; }
        body.ar-active .home-content { display: none; }
        body.ar-active header { display: none; }
    </style>
</head>
<body>

    <header class="main-header">
        <nav>
             <ul class="nav-menu">
                <li><a href="index.html" class="nav-link active" data-i18n="nav_home">Home</a></li>
                <li><a href="synopsis.html" class="nav-link" data-i18n="nav_synopsis">Synopsis</a></li>
                <li><a href="video.html" class="nav-link" data-i18n="nav_video">Video</a></li>
                <li><a href="biodata.html" class="nav-link" data-i18n="nav_biodata">Biodata</a></li>
                <li><a href="contact.html" class="nav-link" data-i18n="nav_contact">Contact</a></li>
            </ul>
        </nav>
    </header>

    <div id="home-screen">
        <div class="home-content">
            <div class="content-left">
                <h1 class="main-title" data-i18n="home_title">Kerajaan<br>Sang Buaya</h1>
                <p class="subtitle" data-i18n="home_subtitle">Scan the images to see the story come alive!</p>
                
                <div class="button-group">
                    <button class="action-btn btn-yellow" onclick="startAR()" data-i18n="btn_scan">ðŸ“· SCAN AR</button>
                    <a href="https://heyzine.com/flip-book/d296a0b263.html" target="_blank" class="action-btn btn-blue" data-i18n="btn_read">ðŸ“š READ E-BOOK</a>
                </div>

                <div class="audio-links">
                    <h2>Language / Bahasa:</h2>
                    <div class="audio-links-grid">
                        <div onclick="switchSiteLanguage('en')" class="audio-link-item lang-btn">ðŸ‡¬ðŸ‡§ English</div>
                        <div onclick="switchSiteLanguage('ms')" class="audio-link-item lang-btn">ðŸ‡²ðŸ‡¾ Melayu</div>
                        <div onclick="switchSiteLanguage('du')" class="audio-link-item lang-btn">ðŸŒ¾ Dusun</div>
                    </div>
                </div>
            </div>
            <div class="content-right">
                <div class="book-wrapper"><img src="Bookcoverpage.jpeg" alt="Book" class="book-3d"></div>
            </div>
        </div>
    </div>

    <div id="ar-ui" style="display: none;">
        <div class="top-bar" style="position:absolute; top:10px; left:10px;">
            <button class="back-btn" onclick="stopAR()" style="padding:10px; background:red; color:white; border:none; border-radius:5px;">â¬… Back to Home</button>
        </div>
        
        <div class="ar-audio-controls">
            <div id="audio-status" class="ar-label">Audio: English</div>
            <button class="ar-btn active-lang" id="btn-audio-en" onclick="changeAudioLang('BI')">ðŸ‡¬ðŸ‡§ EN</button>
            <button class="ar-btn" id="btn-audio-ms" onclick="changeAudioLang('BM')">ðŸ‡²ðŸ‡¾ BM</button>
            <button class="ar-btn" id="btn-audio-du" onclick="changeAudioLang('BKD')">ðŸŒ¾ DUS</button>
        </div>
    </div>

    <a-scene mindar-image="imageTargetSrc: assets/targets/Buaya.mind; autoStart: false; uiScanning: no;" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <a-asset-item id="model-1" src="assets/models/scene1.glb"></a-asset-item>
            <a-asset-item id="model-2" src="assets/models/scene2.glb"></a-asset-item>
            <a-asset-item id="model-3" src="assets/models/scene3.glb"></a-asset-item>
            <a-asset-item id="model-4" src="assets/models/scene4.glb"></a-asset-item>
            <a-asset-item id="model-5" src="assets/models/scene5.glb"></a-asset-item>
            <a-asset-item id="model-6" src="assets/models/scene6.glb"></a-asset-item>
            <a-asset-item id="model-7" src="assets/models/scene7.glb"></a-asset-item>
            <a-asset-item id="model-8" src="assets/models/scene8.glb"></a-asset-item>
            <a-asset-item id="model-9" src="assets/models/scene9.glb"></a-asset-item>
            <a-asset-item id="model-10" src="assets/models/scene10.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" class="target-plane" data-scene="1">
            <a-gltf-model src="#model-1" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>
        
        <a-entity mindar-image-target="targetIndex: 1" class="target-plane" data-scene="2">
            <a-gltf-model src="#model-2" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 2" class="target-plane" data-scene="3">
            <a-gltf-model src="#model-3" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 3" class="target-plane" data-scene="4">
            <a-gltf-model src="#model-4" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 4" class="target-plane" data-scene="5">
            <a-gltf-model src="#model-5" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 5" class="target-plane" data-scene="6">
            <a-gltf-model src="#model-6" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 6" class="target-plane" data-scene="7">
            <a-gltf-model src="#model-7" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 7" class="target-plane" data-scene="8">
            <a-gltf-model src="#model-8" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 8" class="target-plane" data-scene="9">
            <a-gltf-model src="#model-9" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 9" class="target-plane" data-scene="10">
            <a-gltf-model src="#model-10" scale="0.1 0.1 0.1" position="0 -0.4 0" rotation="0 0 0" animation-mixer="loop: repeat"></a-gltf-model>
        </a-entity>

    </a-scene>

    <audio id="bgm-audio" preload="auto"></audio>

    <script src="translations.js"></script>

    <script>
        // Mapping between Text Translation keys (en, ms, du) and Audio Folder keys (BI, BM, BKD)
        const langMap = {
            'en': 'BI',
            'ms': 'BM',
            'du': 'BKD'
        };
        // Reverse mapping for AR buttons to Text
        const reverseLangMap = {
            'BI': 'en',
            'BM': 'ms',
            'BKD': 'du'
        };

        let currentAudioLang = 'BI'; 
        let activeSceneIndex = null;
        const audioElement = document.getElementById('bgm-audio');
        
        document.addEventListener("DOMContentLoaded", () => {
            // 1. Sync Audio Language with stored Text Language
            const storedLang = localStorage.getItem('preferredLanguage') || 'en';
            if (langMap[storedLang]) {
                currentAudioLang = langMap[storedLang];
                updateAudioUI(currentAudioLang);
            }

            // 2. Setup AR Targets
            const targets = document.querySelectorAll('.target-plane');
            
            targets.forEach((target) => {
                target.addEventListener("targetFound", event => {
                    const sceneNum = target.getAttribute('data-scene');
                    console.log("Found Scene: " + sceneNum);
                    activeSceneIndex = sceneNum;
                    playAudio(sceneNum);
                });

                target.addEventListener("targetLost", event => {
                    console.log("Lost Target");
                    activeSceneIndex = null;
                    audioElement.pause();
                    audioElement.currentTime = 0;
                });
            });
        });

        // Main function to switch site-wide language (Text + Audio)
        function switchSiteLanguage(langCode) {
            // Change text via translations.js
            if(typeof changeLanguage === 'function') {
                changeLanguage(langCode);
            }
            
            // Sync Audio Language
            if(langMap[langCode]) {
                currentAudioLang = langMap[langCode];
                updateAudioUI(currentAudioLang);
            }
        }

        // Called by AR buttons (when user toggles inside AR view)
        function changeAudioLang(audioCode) {
            currentAudioLang = audioCode;
            updateAudioUI(audioCode);

            // Also sync text language
            if(reverseLangMap[audioCode] && typeof changeLanguage === 'function') {
                changeLanguage(reverseLangMap[audioCode]);
            }

            // If a target is currently visible, switch the audio immediately
            if (activeSceneIndex) {
                playAudio(activeSceneIndex);
            }
        }

        function updateAudioUI(code) {
            // Remove active class from all AR buttons
            document.querySelectorAll('.ar-btn').forEach(btn => btn.classList.remove('active-lang'));
            
            // Add active class to correct button
            if(code === 'BI') {
                document.getElementById('btn-audio-en')?.classList.add('active-lang');
                if(document.getElementById('audio-status')) document.getElementById('audio-status').innerText = "Audio: English";
            } else if(code === 'BM') {
                document.getElementById('btn-audio-ms')?.classList.add('active-lang');
                if(document.getElementById('audio-status')) document.getElementById('audio-status').innerText = "Audio: B. Melayu";
            } else {
                document.getElementById('btn-audio-du')?.classList.add('active-lang');
                if(document.getElementById('audio-status')) document.getElementById('audio-status').innerText = "Audio: Dusun";
            }
        }

        function playAudio(sceneNum) {
            if (!sceneNum) return;
            // File pattern: assets/sounds/BI/SCENE 1-BI.mp3
            const src = `assets/sounds/${currentAudioLang}/SCENE ${sceneNum}-${currentAudioLang}.mp3`;
            
            audioElement.src = src;
            audioElement.play().catch(e => console.log("Audio play failed (interact first):", e));
        }

        function startAR() {
            const sceneEl = document.querySelector('a-scene');
            if (sceneEl && sceneEl.systems['mindar-image-system']) {
                sceneEl.systems['mindar-image-system'].start();
                document.getElementById('ar-ui').style.display = 'block';
                document.body.classList.add('ar-active'); // Hides home screen via CSS
            } else {
                console.error("MindAR system not ready.");
                alert("AR System is loading, please wait...");
            }
        }

        function stopAR() {
            const sceneEl = document.querySelector('a-scene');
            if (sceneEl && sceneEl.systems['mindar-image-system']) {
                sceneEl.systems['mindar-image-system'].